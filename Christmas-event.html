<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Christmas Celebration — Winter Wonderland</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-0:#061523; --bg-1:#0b3550;
      --panel:#f6f8fb; --muted:#9fbac9;
      --accent:#c9a84b; --accent-holly:#e75a4c; --accent-ice:#8fd3e8;
      --glass: rgba(255,255,255,0.03);
      --input-bg: #e9eef3;
      --card-radius:14px; --max-width:1100px; --gap:18px;
      --text: #061523;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Montserrat,system-ui,Arial;background:
      radial-gradient(600px 220px at 10% 6%, rgba(201,168,75,0.03), transparent 8%),
      linear-gradient(180deg,var(--bg-0),var(--bg-1));color:var(--panel);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:12px auto;padding:18px;position:relative;z-index:2}
    .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:18px;box-shadow: 0 20px 60px rgba(2,8,13,0.45);border:1px solid rgba(255,255,255,0.03)}
    header.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:6px}
    h1{margin:0;font-family:'Great Vibes',cursive;color:var(--accent);font-size:1.8rem}
    .sub{color:var(--muted);font-weight:600;font-size:.95rem}

    .main{display:grid;grid-template-columns:minmax(220px,380px) 1fr;gap:var(--gap);align-items:start;margin-top:16px}

    .poster{ width:100%; border-radius:12px; overflow:visible }
    .poster-card{ border-radius:12px; overflow:hidden; position:relative; box-shadow: 0 12px 36px rgba(3,8,15,0.45); border:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg,#0f2230,#092033) }
    .poster-figure{ margin:0; position:relative; width:100%; aspect-ratio:3/4; overflow:hidden }
    .poster-figure img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; filter:contrast(1.02) saturate(.95)}
    .poster-overlay{ position:absolute; left:0; right:0; bottom:0; padding:12px; background:linear-gradient(180deg, rgba(2,6,11,0.0), rgba(2,6,11,0.65)); color:var(--panel); font-size:.92rem }
    .poster-credit{ margin-top:8px; font-size:0.82rem; color:var(--muted) }

    .meta-header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap }
    .event-title{ margin:0; font-family:'Great Vibes',cursive; color:var(--accent); font-size:1.5rem }
    .venue-sub{ color:var(--muted); font-size:.92rem; margin-top:6px }

    .info{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 }
    .pill{ background:var(--glass); padding:6px 10px; border-radius:999px; font-weight:600; color:var(--panel); font-size:.95rem; border:1px solid rgba(255,255,255,0.03) }

    .synopsis{ color:var(--panel); line-height:1.6; margin-bottom:12px; font-size:1rem }

    .controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
    .btn{ background: linear-gradient(90deg,var(--accent-ice), #7fd5f0); color: #05131a; border:none; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 8px 22px rgba(14,165,247,0.08); display:inline-flex; gap:10px; align-items:center }
    .btn.secondary{ background:transparent; color:var(--panel); border:1px solid rgba(255,255,255,0.06) }

    .countdown{ color:var(--panel); font-weight:700; background: rgba(255,255,255,0.02); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03) }

    .details{ margin-top:10px; padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03) }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .info-card{ padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.03) }
    .info-card h5{ margin:0 0 6px 0; color:var(--accent); font-family: 'Great Vibes', cursive; font-size:1.02rem }
    .muted{ color:var(--muted); font-size:.93rem }

    .snacks-list{ margin-top:8px; color:var(--panel); line-height:1.6; display:none }
    .snacks-list.show{ display:block }

    .rsvp-count{ background: rgba(255,255,255,0.02); padding:6px 10px; border-radius:8px; color:var(--panel); font-weight:700; border:1px solid rgba(255,255,255,0.03); font-size:.95rem }
    .rsvp-card{ margin-top:12px; padding:12px; border-radius:12px; display:flex; gap:12px; align-items:center; justify-content:space-between; border:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)) }

    /* modal/backdrop */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,11,0.65); display:none; align-items:center; justify-content:center; z-index:2000; padding:18px }
    .modal-backdrop.show{ display:flex }
    .modal{ width: min(560px, calc(100% - 40px)); border-radius:12px; padding:18px; background: linear-gradient(180deg,#0f2a3a,#0b2432); color:var(--panel); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 30px 80px rgba(2,6,11,0.6) }
    .modal h3{ margin:0 0 8px 0; font-family:'Great Vibes',cursive; color:var(--accent); font-size:1.4rem }
    .modal label{ display:block; font-size:.92rem; color:var(--muted); margin-top:10px }

    .modal input, .modal select, .modal textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06);
      background: var(--input-bg);
      color: var(--text);
      margin-top:6px;
      appearance:auto;
    }
    .modal input::placeholder, .modal textarea::placeholder{ color: rgba(6,21,35,0.45); }

    .modal select{ padding-right:36px; background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.08) 50%), linear-gradient(135deg, rgba(255,255,255,0.08) 50%, transparent 50%); background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px); background-size:6px 6px,6px 6px; background-repeat:no-repeat; }
    .modal .row{ display:flex; gap:8px; margin-top:6px }
    .modal .row > *{ flex:1 }
    .modal .small-help{ font-size:.85rem; color:var(--muted); margin-top:6px }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:14px }

    .agree{ display:inline-flex; align-items:center; gap:8px; margin-top:10px; cursor:pointer; user-select:none; color:var(--panel) }
    .agree input[type="checkbox"]{ appearance:auto; -webkit-appearance:checkbox; -moz-appearance:checkbox; width:16px; height:16px; margin:0; padding:0; border-radius:4px; accent-color:var(--accent); cursor:pointer; background:transparent; border:1px solid rgba(255,255,255,0.06) }
    .agree span{ color:var(--muted); font-size:.95rem }

    @media (max-width:980px){ .main{ grid-template-columns: 1fr } .grid-2{ grid-template-columns: 1fr } .wrap{ padding:14px } }
    @media (max-width:520px){ h1{ font-size:1.5rem } .btn{ padding:9px 12px; font-size:.95rem } .modal{ padding:14px } }

    .toast{ position:fixed; right:18px; bottom:18px; background:linear-gradient(90deg,var(--accent-holly),#ffd88d); color:#061523; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(2,6,11,0.6); display:none; z-index:3000; font-weight:700 }
    .visually-hidden{ position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px }
  </style>
</head>
<body>
  <canvas class="snow" aria-hidden="true" style="position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:1"></canvas>

  <div class="wrap">
    <header class="top" role="banner">
      <div class="brand">
        <h1 tabindex="0">Winter Wonderland</h1>
        <div class="sub" aria-hidden="true">Christmas Celebration</div>
      </div>
      <div style="text-align:right">
        <div style="color:var(--muted);font-weight:700">Winter Wonderland Hall</div>
        <div style="color:var(--muted);font-size:.92rem;margin-top:6px">Dec 20 — Dec 31 • Evenings</div>
      </div>
    </header>

    <main class="card" role="main" aria-label="Christmas Celebration">
      <header style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:6px">
        <div style="display:flex;gap:12px;align-items:center">
          <button id="backBtn" class="btn secondary" aria-label="Back to events">← Back</button>
          <div>
            <h2 style="margin:0;font-family:'Great Vibes',cursive;color:var(--accent);font-size:1.4rem">Christmas Celebration</h2>
            <div class="sub">Community festival — carols, dinner, movie nights & kids' programs</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="color:var(--muted);font-weight:700">Dec 20 — Dec 31</div>
          <div style="color:var(--muted);font-size:.92rem;margin-top:6px">Evenings • Family friendly</div>
        </div>
      </header>

      <section class="main" aria-labelledby="eventHeading">
        <div class="poster">
          <div class="poster-card" role="img" aria-label="Christmas celebration scene">
            <figure class="poster-figure">
              <img src="https://thumbs.dreamstime.com/b/big-christmas-outdoor-pine-tree-light-decoration-big-christmas-outdoor-pine-tree-light-decoration-111294267.jpg" alt="Christmas lights and tree" loading="lazy" decoding="async">
            </figure>
            <div class="poster-overlay">
              <div style="font-weight:700;color:var(--panel)">Winter Wonderland Hall</div>
              <div style="color:var(--muted);font-size:0.9rem">Carols • Community Dinner • Holiday Movies • Kids' Corner</div>
            </div>
          </div>
          <div class="poster-credit">Photo: dreamstime</div>
        </div>

        <div class="meta">
          <div class="meta-header">
            <div>
              <h3 id="eventHeading" class="event-title">Christmas Celebration</h3>
              <div class="venue-sub">Community festival • Donations welcome</div>
            </div>
            <div style="text-align:right">
              <div class="venue">Winter Wonderland Hall</div>
              <div class="venue-sub">Accessible venue • Volunteer desk</div>
            </div>
          </div>

          <div class="info" aria-hidden="false">
            <span class="pill">Dec 20 — Dec 31</span>
            <span class="pill">Evening festivities</span>
            <span class="pill">Holiday Movie Nights</span>
          </div>

          <p class="synopsis">Join our multi-evening Christmas celebration — nightly carols, community dinners, ornament workshops, kids' gift corner on Dec 25 and Holiday Movie Night screenings. Volunteers & donations help us run free activities.</p>

          <div class="controls" id="controlBar">
            <button id="detailsBtn" class="btn secondary" aria-expanded="false" aria-controls="detailsPanel">Program & Venue</button>
            <button id="snacksBtn" class="btn secondary" aria-expanded="false" aria-controls="snacksList">Food & Drinks</button>

            <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
              <button class="btn" id="rsvpBtn" aria-haspopup="dialog">RSVP</button>
              <div id="rsvpCount" class="rsvp-count" aria-live="polite">0 RSVPs</div>
            </div>

            <div class="countdown" id="countdown" data-date="2025-12-20T17:00:00" aria-live="polite">Loading...</div>
          </div>

          <div id="rsvpCardContainer" aria-live="polite"></div>

          <div id="detailsPanel" class="details" aria-hidden="true">
            <div class="grid-2">
              <div class="info-card">
                <h5>Evening Schedule</h5>
                <div class="muted">6:00 PM — Carols & Welcome<br>6:30 PM — Community Dinner<br>7:30 PM — Performances & Kids' corner</div>
              </div>
              <div class="info-card">
                <h5>Holiday Movie Nights</h5>
                <div class="muted">Family films on select nights with hot cocoa and popcorn. See schedule at the desk.</div>
              </div>
              <div class="info-card">
                <h5>Donations & Volunteers</h5>
                <div class="muted">Donate toys/food at drop-off or contact us to volunteer. Volunteer desk open each evening.</div>
              </div>
              <div class="info-card">
                <h5>Accessibility & Parking</h5>
                <div class="muted">Wheelchair accessible, ramps & adaptive seating. Paid lot on-site; bus stop nearby.</div>
              </div>
            </div>
          </div>

          <div id="snacksList" class="snacks-list" aria-hidden="true">
            <ul style="margin:8px 0 0 18px; color:var(--panel)">
              <li>Community dinner (rotating menu)</li>
              <li>Hot cocoa & spiced cider</li>
              <li>Popcorn & seasonal pastries</li>
              <li>Kid's snack packs & gluten-free options</li>
            </ul>
            <div class="muted" style="margin-top:8px">Tell us dietary needs at the welcome desk.</div>
          </div>
        </div>
      </section>

      <footer class="footer" style="margin-top:14px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>Location: <strong style="color:var(--accent)">Winter Wonderland Hall</strong></div>
        <div><a href="Event-location.html" style="color:var(--muted);text-decoration:none">See all event locations →</a></div>
      </footer>
    </main>
  </div>

  <!-- RSVP modal -->
  <div class="modal-backdrop" id="rsvpModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rsvpTitle">
      <h3 id="rsvpTitle">RSVP — Christmas Celebration</h3>
      <form id="rsvpForm" novalidate>
        <label for="rsvpName">Full name <span style="color:var(--accent)">*</span></label>
        <input id="rsvpName" name="name" type="text" required autocomplete="name" placeholder="Your name">

        <label for="rsvpEmail">Email (optional)</label>
        <input id="rsvpEmail" name="email" type="email" autocomplete="email" placeholder="name@example.com">

        <div class="row">
          <div>
            <label for="rsvpGuests">Guests</label>
            <select id="rsvpGuests" name="guests" aria-label="Number of guests">
              <option value="0">0</option>
              <option value="1">+1</option>
              <option value="2">+2</option>
              <option value="3">+3</option>
              <option value="4">+4</option>
            </select>
            <div class="small-help">Select how many will join you (max 4).</div>
          </div>
          <div>
            <label for="rsvpPhone">Phone (optional)</label>
            <input id="rsvpPhone" name="phone" type="tel" placeholder="(optional)">
          </div>
        </div>

        <label class="agree" for="rsvpAgree">
          <input type="checkbox" id="rsvpAgree" required>
          <span>I agree to event terms</span>
        </label>

        <div class="actions">
          <button type="button" id="rsvpCancel" class="btn secondary">Cancel</button>
          <button type="submit" class="btn">Confirm RSVP</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel feedback modal (two questions) -->
  <div class="modal-backdrop" id="cancelModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cancelTitle">
      <h3 id="cancelTitle">Cancel RSVP — Quick questions</h3>
      <form id="cancelForm" novalidate>
        <label for="cancelReason">Why are you cancelling?</label>
        <select id="cancelReason" name="reason" required>
          <option value="">Choose a reason</option>
          <option value="schedule">Schedule conflict</option>
          <option value="illness">Illness / safety</option>
          <option value="changed">Changed plans</option>
          <option value="cost">Cost / other</option>
          <option value="other">Other</option>
        </select>

        <label for="cancelDetails">Anything you'd like to tell us? (optional)</label>
        <textarea id="cancelDetails" name="details" rows="4" placeholder="Optional details..."></textarea>

        <div class="small-help" style="margin-top:8px;color:var(--muted)">Your feedback helps us improve future events.</div>

        <div class="actions">
          <button type="button" id="cancelBack" class="btn secondary">Back</button>
          <button type="submit" id="confirmCancelBtn" class="btn">Confirm cancellation</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      /* decorative flakes */
      (function(){
        const canvas = document.querySelector('.snow'); if(!canvas) return;
        const ctx = canvas.getContext('2d'); let flakes=[];
        function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; create(); }
        function create(){ flakes=[]; const count=Math.max(12,Math.round((innerWidth*innerHeight)/110000)); for(let i=0;i<count;i++) flakes.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.6+0.6,s:Math.random()*1.2+0.2,a:Math.random()*0.7+0.15}); }
        function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(const f of flakes){ ctx.beginPath(); ctx.fillStyle=`rgba(255,255,255,${f.a})`; ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); f.y+=f.s; f.x+=Math.sin(f.y/40)*0.3; if(f.y>canvas.height){ f.y=-8; f.x=Math.random()*canvas.width; } } requestAnimationFrame(draw); }
        addEventListener('resize',resize); resize(); draw();
      })();

      /* countdown */
      (function(){ const el=document.getElementById('countdown'); if(!el) return; function update(){ const target=new Date(el.dataset.date); const now=new Date(); const diff=target-now; if(diff<=0){ el.textContent='Event running — drop in evenings through Dec 31'; return; } const d=Math.floor(diff/86400000), h=Math.floor((diff%86400000)/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000); el.textContent=`Starts in ${d}d ${h}h ${m}m ${s}s`; } update(); setInterval(update,1000); })();

      /* small toast helper */
      function toast(msg, ms=2600){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=> t.style.display='none', ms); }

      /* back button */
      document.getElementById('backBtn')?.addEventListener('click', ()=>{ try{ if(history.length>1) history.back(); else location.href='index.html'; }catch(e){ location.href='index.html'; } }, {passive:true});

      /* details & snacks toggles */
      (function(){
        const detailsBtn=document.getElementById('detailsBtn'), detailsPanel=document.getElementById('detailsPanel');
        const snacksBtn=document.getElementById('snacksBtn'), snacksList=document.getElementById('snacksList');
        if(detailsBtn && detailsPanel){
          detailsBtn.addEventListener('click', ()=> {
            const open = detailsBtn.getAttribute('aria-expanded')==='true';
            detailsBtn.setAttribute('aria-expanded', String(!open));
            detailsPanel.setAttribute('aria-hidden', String(open));
            detailsBtn.textContent = open ? 'Program & Venue' : 'Hide Info';
            if(!open){ detailsPanel.scrollIntoView({behavior:'smooth', block:'nearest'}); detailsPanel.querySelector('h5')?.focus?.(); }
          }, {passive:true});
        }
        if(snacksBtn && snacksList){
          snacksBtn.addEventListener('click', ()=> {
            const open = snacksBtn.getAttribute('aria-expanded')==='true';
            snacksBtn.setAttribute('aria-expanded', String(!open));
            snacksList.classList.toggle('show');
            snacksBtn.textContent = open ? 'Food & Drinks' : 'Hide Snacks';
            if(!open) snacksList.querySelector('li')?.focus?.();
          }, {passive:true});
        }
      })();

      /* RSVP + cancellation flow */
      (function(){
        const EVENT_KEY = 'Christmas Celebration';
        const STORE_KEY = 'ww_rsvps_v1';
        const USER_KEY  = 'ww_rsvp_user_v1';

        const rsvpBtn = document.getElementById('rsvpBtn');
        const rsvpCountEl = document.getElementById('rsvpCount');
        const rsvpModal = document.getElementById('rsvpModal');
        const rsvpForm = document.getElementById('rsvpForm');
        const rsvpCancel = document.getElementById('rsvpCancel');

        const cancelModal = document.getElementById('cancelModal');
        const cancelForm = document.getElementById('cancelForm');
        const cancelBack = document.getElementById('cancelBack');

        const rsvpCardContainer = document.getElementById('rsvpCardContainer');

        function readStore(){ try{return JSON.parse(localStorage.getItem(STORE_KEY)||'{}')}catch{return{}} }
        function writeStore(v){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(v)); }catch{} }
        function readUser(){ try{return JSON.parse(localStorage.getItem(USER_KEY)||'{}')}catch{return{}} }
        function writeUser(v){ try{ localStorage.setItem(USER_KEY, JSON.stringify(v)); }catch{} }

        function list(){ const s=readStore(); return Array.isArray(s[EVENT_KEY])?s[EVENT_KEY]:[] }
        function save(entry){ const s=readStore(); if(!Array.isArray(s[EVENT_KEY])) s[EVENT_KEY]=[]; s[EVENT_KEY].push(entry); writeStore(s) }
        function removeById(id){ const s=readStore(); if(!Array.isArray(s[EVENT_KEY])) return; s[EVENT_KEY]=s[EVENT_KEY].filter(e=>e.id!==id); writeStore(s) }

        function storeCancellationFeedback(entry){
          try{
            const s=readStore();
            if(!Array.isArray(s._cancellations)) s._cancellations=[];
            s._cancellations.push(entry);
            writeStore(s);
          }catch{}
        }

        function updateCount(){ const l=list(); rsvpCountEl.textContent = `${l.length} RSVP${l.length===1?'':'s'}` }
        function currentId(){ const u=readUser(); return u[EVENT_KEY]||null }

        /* modal helpers */
        let lastFocused=null;
        function trapFocus(container){
          lastFocused=document.activeElement;
          const focusables=container.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
          if(!focusables.length) return;
          const first=focusables[0], last=focusables[focusables.length-1];
          function onKey(e){
            if(e.key==='Tab'){
              if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
              else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
            } else if(e.key==='Escape'){ hideModal(container); }
          }
          container._onKey = onKey;
          document.addEventListener('keydown', onKey);
        }
        function releaseFocusTrap(container){ if(container && container._onKey){ document.removeEventListener('keydown', container._onKey); container._onKey=null; } if(lastFocused && lastFocused.focus) lastFocused.focus(); }

        function showModal(backdrop){
          backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false');
          setTimeout(()=> backdrop.querySelector('input,select,textarea,button')?.focus(),60);
          trapFocus(backdrop);
        }
        function hideModal(backdrop){
          backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true');
          releaseFocusTrap(backdrop);
        }

        /* render user card */
        function renderUserCard(){
          rsvpCardContainer.innerHTML='';
          const id = currentId();
          if(!id) return;
          const me = list().find(x=>x.id===id);
          if(!me) return;
          const card=document.createElement('div'); card.className='rsvp-card';
          const meta=document.createElement('div'); meta.className='meta';
          const name=document.createElement('b'); name.textContent = me.name;
          const small=document.createElement('div'); small.className='muted'; small.textContent = `Guests: ${me.guests} · ${me.email||'no email'}`;
          meta.appendChild(name); meta.appendChild(small);

          const actions=document.createElement('div'); actions.className='rsvp-actions';
          const edit=document.createElement('button'); edit.className='btn secondary'; edit.textContent='Edit'; edit.addEventListener('click', openRSVPModalForEdit);
          const cancel=document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel RSVP'; cancel.addEventListener('click', ()=> openCancelModal(id));
          actions.appendChild(edit); actions.appendChild(cancel);

          card.appendChild(meta); card.appendChild(actions);
          rsvpCardContainer.appendChild(card);
        }

        function openRSVPModalForEdit(){
          const id=currentId();
          if(!id){ showModal(rsvpModal); return; }
          const me = list().find(x=>x.id===id);
          if(me){
            rsvpForm.rsvpName.value = me.name||'';
            rsvpForm.rsvpEmail.value = me.email||'';
            rsvpForm.rsvpGuests.value = me.guests||'0';
            rsvpForm.rsvpPhone.value = me.phone||'';
            rsvpForm.querySelector('#rsvpAgree').checked = true;
          }
          showModal(rsvpModal);
        }

        /* open cancel modal */
        let _pendingCancelId = null;
        function openCancelModal(id){
          _pendingCancelId = id || currentId();
          if(!_pendingCancelId){ toast('No RSVP found to cancel.'); return; }
          cancelForm.cancelReason.value = '';
          cancelForm.cancelDetails.value = '';
          showModal(cancelModal);
        }

        // cancel modal wiring
        cancelForm.addEventListener('submit', function(ev){
          ev.preventDefault();
          if(!_pendingCancelId){ hideModal(cancelModal); return; }
          const reason = cancelForm.cancelReason.value || 'unspecified';
          const details = (cancelForm.cancelDetails.value || '').trim();
          storeCancellationFeedback({ id: _pendingCancelId, reason, details, ts: new Date().toISOString() });

          removeById(_pendingCancelId);
          const u = readUser(); delete u[EVENT_KEY]; writeUser(u);

          _pendingCancelId = null;
          updateCount(); renderUserCard();
          hideModal(cancelModal);
          toast('Your RSVP was cancelled. Thanks for the feedback.');
        }, {passive:false});

        cancelBack.addEventListener('click', function(){ hideModal(cancelModal); }, {passive:true});

        // RSVP modal wiring
        if(rsvpBtn) rsvpBtn.addEventListener('click', openRSVPModalForEdit, {passive:true});
        if(rsvpCancel) rsvpCancel.addEventListener('click', ()=> hideModal(rsvpModal), {passive:true});
        rsvpModal.addEventListener('click', function(e){ if(e.target===rsvpModal) hideModal(rsvpModal); });
        cancelModal.addEventListener('click', function(e){ if(e.target===cancelModal){ _pendingCancelId=null; hideModal(cancelModal); } });

        // RSVP submit
        rsvpForm.addEventListener('submit', function(ev){
          ev.preventDefault();
          const name = rsvpForm.rsvpName.value.trim();
          if(!name){ toast('Please enter your name.'); rsvpForm.rsvpName.focus(); return; }
          const agree = rsvpForm.querySelector('#rsvpAgree');
          if(!agree || !agree.checked){ toast('Please agree to event terms.'); agree?.focus(); return; }
          const email = rsvpForm.rsvpEmail.value.trim();
          const guests = rsvpForm.rsvpGuests.value;
          const phone = rsvpForm.rsvpPhone.value.trim();

          const u = readUser(); const existingId = u[EVENT_KEY] || null;

          if(existingId){
            const arr = list(); const idx = arr.findIndex(x=>x.id===existingId);
            if(idx!==-1){ arr[idx] = Object.assign({}, arr[idx], { name, email, guests, phone, updated:new Date().toISOString() }); const s=readStore(); s[EVENT_KEY]=arr; writeStore(s); toast('RSVP updated.'); }
          } else {
            const id = 'rsvp_' + Date.now();
            const entry = { id, name, email, guests, phone, created:new Date().toISOString() };
            save(entry);
            const nu = readUser(); nu[EVENT_KEY] = id; writeUser(nu);
            toast('Thanks — your RSVP is recorded.');
          }

          updateCount(); renderUserCard(); hideModal(rsvpModal);
        }, {passive:false});

        // init
        updateCount(); renderUserCard();
      })();

    })();
  </script>
</body>
</html>
